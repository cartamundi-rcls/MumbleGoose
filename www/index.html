<html>
	<head>
		<script type="text/javascript" src="jquery-1.11.0.js"></script>
		<script type="text/javascript" src="ChangeTheme.js"></script>

		<title id="docTitle">Music player</title>
		
		<link rel="stylesheet" type="text/css" title="dark" href="dark.css">
		<link rel="alternate stylesheet" type="text/css" title="light" href="light.css">
		<link rel="alternate stylesheet" type="text/css" title="pink" href="pink.css">
		<link rel="alternate stylesheet" type="text/css" title="pic" href="pic.css">
	</head>

	<body onload="set_style_from_cookie()">
		<div id="wrapper">
			<table width="100%" class="centered">
				<tr>
					<td align="center"><a href="request.html">Request</a></td>
					<td align="center"><a href="upload.html" target="_blank">Upload</a></td>
					<td align="center"><a href="javascript:addnew()">Search and Add new Files</a></td>
					<td align="center"><a id="streamButton" href="javascript:startstream()">Stream</a></td>
					<td align="center"><a href="soundbytes.html">SoundBytes</a></td>
				</tr>
			</table>

			<h1 class="centered">Music Player 2.2 <span style="font-size: 1px;">infinite</span> BETA! Now with streaming support</h1>

			<div class="topbuttonwrapper">
				<a class="controlButton" href='javascript:play()'><p class="centered smallbutton">Play</p></a>
				<a class="controlButton" href='javascript:pause()'><p class="centered smallbutton">Pause</p></a>
				<a class="controlButton" href='javascript:next()'><p class="centered smallbutton">Next</p></a>
			</div>
			<br/>
			<div class="ratingwrapper">
				<span class="rating">
					<!-- FROM: http://kubyshkin.ru/posts/star-rating-input-pure-css.html -->
			        <input type="radio" class="rating-input" id="rating-input-1-5" name="rating-input-1" onclick="javascript:setRating(100)"/>
			        <label for="rating-input-1-5" class="rating-star"></label>

			        <input type="radio" class="rating-input" id="rating-input-1-4" name="rating-input-1" onclick="javascript:setRating(75)"/>
			        <label for="rating-input-1-4" class="rating-star"></label>

			        <input type="radio" class="rating-input" id="rating-input-1-3" name="rating-input-1" onclick="javascript:setRating(50)"/>
			        <label for="rating-input-1-3" class="rating-star"></label>

			        <input type="radio" class="rating-input" id="rating-input-1-2" name="rating-input-1" onclick="javascript:setRating(25)"/>
			        <label for="rating-input-1-2" class="rating-star"></label>

			        <input type="radio" class="rating-input" id="rating-input-1-1" name="rating-input-1" onclick="javascript:setRating(0)"/>
			        <label for="rating-input-1-1" class="rating-star"></label>
				</span>
			</div>
			<div class="centered" style="margin-bottom:30px; margin-top:30px;">
				<form>
					<input class="volumeButton" type="text" id="volumeformfield" value="0" maxlength="2" tabindex="-1" style="width:35px" />
					<input class="volumeButton" type="button" value="-" onClick="decreaseVolume(0.03)">
					<input class="volumeButton" type="button" value="+" onClick="increaseVolume(0.03)"><br/><br/>
					<input class="volumeButton" type="button" value="Set Volume" onClick="setvolume()"/>
				</form>
			</div>

			<table width="100%" class="centered" style="margin-top:50px; margin-bottom:16px;">
				<tr>
					<th>Artist<th>
					<th>Album<th>
					<th>Title<th>
					<th>Rating<th>
					<th>Comments<th>
					<th></th>
				</tr>
				<tr>
					<td id="artistcell">null<td>
					<td id="albumcell">null<td>
					<td id="titlecell">null<td>
					<td id="ratingcell">null<td>
					<td id="commentscell">null<td>
					<td><a href="edit.html" target="_blank">EDIT</a></td>
				</tr>
			</table>
			<hr>

			<br />
			<table class="centered" width="100%" id="requests"></table>
			<table class="centered" width="100%" id="playlist"></table>
			<br />

			<center>
				<input type="button" class="bottomButton" value="DELETE CURRENT SONG" onClick="deleteCurrentSong()"  />
				<input type="button" class="bottomButton" value="DELETE ALL SONG" onClick="deleteAllSongs()"  />
			</center>
			<br />
			<center class="themeButtons">
				<form>
					<input type="submit" class="bottomButton" onclick="switch_style('light');return false;" name="theme" value="Light Theme" id="light">
					<input type="submit" class="bottomButton" onclick="switch_style('dark');return false;" name="theme" value="Dark Theme" id="dark">
					<input type="submit" class="bottomButton" onclick="switch_style('pink');return false;" name="theme" value="Girly Theme" id="pink">
					<input type="submit" class="bottomButton" onclick="switch_style('pic');return false;" name="theme" value="Picture Theme" id="pic">
					<input type="button" class="bottomButton" onclick="fancyshit()" value="Surprise me!">
				</form>
			</center>
		</div>

		<!--<audio controls id="audioplayer">
		  <source src="" type="audio/mpeg">
		Your browser does not support the audio element.
		</audio>-->
	</body>

	<script>

function fancyshit()
{
	var randomImageURL = 'url("http://home.melvin-kellner.com/image.png?brol=' + Math.random() + '")';
	document.body.style.background =  randomImageURL;
}





var refreshTimer = 500;
window.setInterval(refresh, refreshTimer);

var currentSongId = -1;
var streamCacheSize = 3;

var audioplayer = document.getElementById("audioplayer");
var currentSongLocation = null;
var prevSongLoc = null;
var porturl = window.location.protocol + '//' + window.location.hostname + ':8080' + window.location.pathname + "index.html";
//var porturl = "http:" + '//' + "localhost" + ':8080' + "/" + "index.html";
var nextSound = "";
var vetoSound = "";
var isnexted = false;
var isvetoed = false;
setSounds();

function refresh()
{
	getPlayerStatus();
	stream();
}


function setSounds()
{
	$.ajax({
		type: 'GET',
		url: porturl,
		data: 'playerstatus=playerstatus',
		dataType: 'json',
		timeout: 6000,
		cache: false,
		success: function(result)
		{
			nextSound = $.parseJSON('[' + result["nextSound"] + ']')[0]
			vetoSound =$.parseJSON('[' + result["vetoSound"] + ']')[0]
		},
	});
}

function getPlayerStatus()
{
	$.ajax({
	type: 'GET',
	url: porturl,
	data: 'playerstatus=playerstatus',
	dataType: 'json',
	timeout: 3000,
	cache: false,
	success: function(result) 
	{
        setCurrentSong($.parseJSON('[' + result["currentsong"] + ']')[0]);
       	setPlayList($.parseJSON('[' + result["playlist"] + ']')[0]);
       	setRequests($.parseJSON('[' + result["requests"] + ']')[0]);
       	setVolume($.parseJSON('[' + result["volume"] + ']')[0]);
       	setduration($.parseJSON('[' + result["duration"] + ']')[0]);
       	isNexted($.parseJSON('[' + result["isnexted"] + ']')[0]);
	},
	});
}

function isNexted(bool)
{
	if (isnexted && !bool)
	{
		isvetoed = true;
		playVeto();
	}
	if (!isnexted && bool)
	{
		isnexted = true;
		playNextSound();
	}
}

function setCurrentSong(result)
{
	if (result != undefined)
	{
		if (currentSongs != result)
		{
			isnexted = false;
			isvetoed = false;
		}
		currentSong = result;
		currentSongLocation = result["path"];
		currentSongId = result["id"];
		document.getElementById("artistcell").innerHTML = result["artist"];
		document.getElementById("albumcell").innerHTML = result["album"];
		document.getElementById("titlecell").innerHTML = result["title"];
		$('#content1').html(result[0]);
		document.getElementById("docTitle").innerHTML = result["artist"] + " - " + result["title"];
	}
	else
	{
		currentSong = null;
		currentSongLocation = null;
		currentSongId = null;
		document.getElementById("artistcell").innerHTML = null;
		document.getElementById("albumcell").innerHTML = null;
		document.getElementById("titlecell").innerHTML = null;
		$('#content1').html(null);
		document.getElementById("docTitle").innerHTML = null + " - " + null;
	}
}

function setPlayList(result)
{
	playlist = result;
	var table = document.getElementById("playlist");
	table.innerHTML = "";
	for (var i=0;i<result.length;i++)
	{
                	 // Insert a row in the table at the last row
		var newRow   = table.insertRow(i);

		// Insert a cell in the row at index 0
		var placeCell  = newRow.insertCell(0);
		var artistCell  = newRow.insertCell(1);
		var albumCell  = newRow.insertCell(2);
		var titleCell  = newRow.insertCell(3);

		// Append a text node to the cell
		var place = document.createTextNode(i + 1);
		placeCell.appendChild(place);
		try 
		{
			var artist = document.createTextNode(result[i]["artist"])
			artistCell.appendChild(artist); 
		}
		catch (err)
		{}

		try
		{
			var album = document.createTextNode(result[i]["album"])
			albumCell.appendChild(album); 
		}
		catch (err)
		{}

		try
		{
			var song = document.createTextNode(result[i]["title"])
			titleCell.appendChild(song);
		}
		catch (err)
		{}  
	}
}

function setRequests(result)
{
	requests = result;
    var table = document.getElementById("requests");
    table.innerHTML = "";

    if(result == 0) return;


    for (var i=0;i<result.length;i++)
    {
             // Insert a row in the table at the last row
            var newRow   = table.insertRow(i);

            // Insert a cell in the row at index 0
            var placeCell  = newRow.insertCell(0);
            var artistCell  = newRow.insertCell(1);
            var albumCell  = newRow.insertCell(2);
            var titleCell  = newRow.insertCell(3);

            // Append a text node to the cell
            try
			{
            	var place = document.createTextNode("REQUEST"); // + (i + 1)
            	placeCell.appendChild(place);
        	}
        	catch (err)
        	{}
        	
        	try
			{
            	var artist = document.createTextNode(result[i]["artist"])
            	artistCell.appendChild(artist); 
            }
        	catch (err)
        	{}

            try
			{
            	var album = document.createTextNode(result[i]["album"])
            	albumCell.appendChild(album); 
            }
        	catch (err)
        	{}

            try
			{
            	var song = document.createTextNode(result[i]["title"])
            	titleCell.appendChild(song); 
            }
        	catch (err)
        	{} 
    }
}

function setVolume(result)
{
	if (document.getElementById("volumeformfield") != document.activeElement)
	{
		document.getElementById("volumeformfield").value = result * 100;
	}
	$('#content1').html(result);
}

function setduration(result)
{

}


function getRequests()
{
        $.ajax({
                type: 'GET',
                url: porturl,
            data: 'getrequests=getrequests',
            dataType: 'json',
            timeout: 3000,
            cache: false,
            success: function(result) 
                {
                	setRequests(result);
            },
          });
}

function getQueList()
{
	$.ajax({
                type: 'GET',
                url: porturl,
            data: 'getplaylist=getplaylist',
            dataType: 'json',
            timeout: 3000,
            cache: false,
            success: function(result) 
                {
                	setPlayList(result);
            },
          });
}

function getCurrentSong()
{
	$.ajax({
		type: 'GET',
		url: porturl,
	    data: 'getcurrentsong=currentsong',
	    dataType: 'json',
            timeout: 3000,
	    cache: false,
	    success: function(result) 
		{
			setCurrentSong(result);
	    },
		});
}

function deleteCurrentSong()
{
	if (confirm('Are you sure you want to delete this song ?')) 
	{
    		next();
		$.ajax({ url: porturl +"?deletesong=" + currentSongId});
		alert("song deleted");
	} 
	else 
	{
   		alert("song not deleted");
	}
}

function increaseVolume(val)
{
	var vol = parseInt(document.getElementById("volumeformfield").value) / 100 + val;
	document.getElementById("volumeformfield").value = vol * 100;
	$.ajax({ url: porturl +"?setvolume=" + vol});
}

function decreaseVolume(val)
{
	var vol = parseInt(document.getElementById("volumeformfield").value) / 100 - val;
	document.getElementById("volumeformfield").value = vol * 100;
	$.ajax({ url: porturl +"?setvolume=" + vol});	
}

function play()
{
	$.ajax({url: porturl + "?play=play"});
}

function pause()
{
	$.ajax({url: porturl + "?pause=pause"});
}

function next()
{
	$.ajax({url: porturl + "?next=next"});
}

function getvolume()
{
	$.ajax({
		type: 'GET',
		url: porturl,
	    data: 'getvolume=getvolume',
	    dataType: 'json',
            timeout: 3000,
	    cache: false,
	    success: function(result) 
		{
			setVolume(result);
	    },
		});
}

function addnew()
{
	alert("Searching and adding new files!");
	$.ajax({url: porturl + "?scanForNew=scanForNew"});
}

function setvolume()
{
	var vol = document.getElementById("volumeformfield").value / 100;
	$.ajax({ url: porturl +"?setvolume=" + vol});
}

function setRating(rating)
{
	alert("werkt nie");
}

var currentSong;
var requests;
var playlist;
var cachedSong = new Array();
var streaming = false;
var player = getPlayer();
var playingId = -1;
var start_time;

function startstream()
{
	if (streaming)
	{
		stopstream();
	}
	else
	{
		$.ajax({
		type: 'GET',
		url: porturl,
		data: 'stream=start',
		dataType: 'json',
		cache: false,
		success: function(result)
		{
			var istreaming = result["isStreaming"];
			if (isstreaming == 1)
		  {
			 	streaming = true;
		  }
			streamCacheSize = result["cacheSize"];
			document.getElementById("streamButton").innerHTML = "STOP STREAM";
		},
		});
	}
	
}

function stopstream()
{
	$.ajax({url: porturl + "?stream=stop"});
	streaming = false;
	player.pause;
	player.src = "";
	cachedSong = new Array();
	playingId = -1;
	document.getElementById("streamButton").innerHTML = "Stream";
}

function stream()
{
	if (streaming)
	{
		$.ajax({
		type: 'GET',
		url: porturl,
		data: 'stream=status',
		dataType: 'json',
		cache: false,
		success: function(result)
		{
			if (result["isPlaying"] === "true")
			{
				playInSync(result["currentPlayTime"])
			}
			else if (!player.paused)
			{
				player.pause();
			}
			if (typeof currentSong !== 'undefined') 
			{
				if (setCachedSong(currentSong["id"]))
				{
					return;	
				}
			}
			if (typeof requests !== 'undefined') 
			{
				for (i=0;i<requests.length;i++)
				{
					if (requests[i] != null)
					{
						if (setCachedSong(requests[i]["id"]))
						{
							return;
						}
						
					}
				}
			}
			if (typeof playlist !== 'undefined') 
			{
				for (i=0;i<playlist.length;i++)
				{
					if (playlist[i] != null)
					{
						if (setCachedSong(playlist[i]["id"]))
						{
							return;
						}
						
					}
				}
			}
		},
		});
	}
}

function playInSync(position)
{
	if (cachedSong[currentSong["id"]] != null && cachedSong[currentSong["id"]] != "null" && cachedSong[currentSong["id"]] != "attempting")
	{
		if (playingId != currentSong["id"])
		{
			start_time = new Date().getTime()
			cachedSong[playingId] == null;
			playingId = currentSong["id"];	
			player.addEventListener('ended', function(e)
			{
			  player.src = null; 
			}, false);

			player.src = "data:audio/mp3;base64," + cachedSong[currentSong["id"]];
			
			player.autoplay = true;
			start_time = (new Date().getTime() - start_time) / 1000;
		}
		position = Number(position);
		if (player.currentTime < position - 2 || player.currentTime > position + 2)
		{
			player.currentTime = Number(position) + (refreshTimer / 1000) + 0.25;
		}
		if (player.paused)
		{
			player.currentTime = Number(position) + (refreshTimer / 1000) + 0.25 + start_time;
			player.play();
			start_time = null;	
		}	
	}
}


function getPlayer() 
{
	var container = getContainer(), player
	, players = container.getElementsByTagName("audio");
	player = document.createElement("audio");
	container.appendChild(player);
	return player;
}

function getContainer() {
	var container = document.getElementById("musicplayer");
	if (container === null) 
	{
		container = document.createElement("div");
		container.id = "musicplayer";
		document.getElementsByTagName('body')[0].appendChild(container);
	}
	return container;
}


function setCachedSong(id)
{
	if (cachedSong[id] == null || cachedSong[id] == "null" || cachedSong[id] == "attempting")
	{
		if (cachedSong.length < streamCacheSize)
		{
			if (cachedSong[id] != "attempting")
			{
				cachedSong[id] = "attempting";
				$.ajax({
				type: 'GET',
				url: porturl,
				data: 'getsongbase64byid='+id,
				dataType: 'text',
				cache: false,
				success: function(result)
				{
					cachedSong[id] = result;
				},
				error: function (data)
				{
							cachedSong[id] = null;
					}
				});
			}
			return true;
		}
	}
	return false;
}





	</script>
</html>
